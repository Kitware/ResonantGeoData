{% extends "geodata/_base/detail.html" %}

{% block meta_table_body %}
  <tr>
    <td>Description</td>
    <td>{{ object.description }}</td>
  </tr>
  <tr>
    <td>Video File Size</td>
    <td>{{ object.fmv_file.file.size|filesizeformat }}</td>
  </tr>
  <tr>
    <td>KLV Metadata</td>
    <td>{{ object.klv_data_link }}</td>
  </tr>
  <tr>
    <td>Original FMV Video</td>
    <td>{{ object.fmv_file.fmv_data_link }}</td>
  </tr>

{% endblock %}

{% block detail %}

    <video width="320" height="240" autobuffer="autobuffer" autoplay="autoplay" loop="loop" controls="controls" id="fmv_video">
      <source src="{{ object.web_video_file.url }}" type='video/mp4; codecs="avc1.42E01E, mp4a.40.2"'>
    </video>

    <p/>

    {% include 'geodata/_includes/viewer.html' %}

    <script>
      let frameRate = JSON.parse('{{ frame_rate|escapejs }}');
      var video = document.getElementById("fmv_video");

      if (extents.ground_frames !== undefined) {
        let polys = JSON.parse(extents.ground_frames);
        let frameNumbers = extents.frame_numbers;

        var frameFootprint = layer.createFeature('polygon')
          .style({
            fillColor: 'red',
            opacity: 0.5
          })

        var callback = () => {
          let frame = Math.round(video.currentTime * frameRate);
          let index = frameNumbers.indexOf(frame);
          if (index > -1) {
            var coords = polys.coordinates[index][0]
            var data = [[
              {x: coords[0][0], y: coords[0][1]},
              {x: coords[1][0], y: coords[1][1]},
              {x: coords[2][0], y: coords[2][1]},
              {x: coords[3][0], y: coords[3][1]},
              {x: coords[4][0], y: coords[4][1]}
            ]]

            frameFootprint.data(data).draw();
          }
        }

        video.addEventListener('timeupdate', callback);
      }
    </script>

{% endblock %}
